<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Space Defender</title>
    <style>
        :root {
            --accent: #4a47a3;
            --bg-top: #0f0c29;
            --bg-mid: #302b63;
            --bg-bottom: #24243e;
        }
        html,body{
            height:100%;
            margin:0;
        }
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(to bottom, var(--bg-top), var(--bg-mid), var(--bg-bottom));
            font-family: 'Arial', sans-serif;
            color: white;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            width: min(800px, 95vw);
            max-width: 800px;
            text-align: center;
            touch-action: none;
        }
        #game-canvas {
            border: 2px solid var(--accent);
            border-radius: 8px;
            background-color: #0a0a2a;
            box-shadow: 0 0 20px rgba(74, 71, 163, 0.5);
            display: block;
            width: 100%;
            height: auto;
            -webkit-tap-highlight-color: transparent;
        }
        #game-ui { 
            display:flex; 
            justify-content:space-between; 
            margin-bottom:10px; 
            font-size:18px; 
            align-items: center;
        }
        #score, #lives { 
            font-size:18px; 
            font-weight:bold; 
            text-shadow:0 0 5px var(--accent); 
        }
        #pause-button {
            background: transparent;
            border: 2px solid var(--accent);
            color: white;
            padding: 8px 16px;
            font-size: 16px;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(74,71,163,0.5);
            transition: all 0.18s ease;
            display: none; /* Hidden by default */
        }
        #pause-button:hover, #pause-button:active { 
            background: rgba(74,71,163,0.2);
            box-shadow: 0 0 12px rgba(74,71,163,0.7);
        }
        #start-screen, #game-over, #pause-screen {
            position:absolute; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%;
            display:flex; 
            flex-direction:column; 
            justify-content:center; 
            align-items:center;
            background-color: rgba(10,10,42,0.95); 
            border-radius:8px; 
            padding:20px;
            z-index: 100;
        }
        #game-over, #pause-screen { 
            display:none; 
        }
        h1 { 
            color:var(--accent); 
            font-size:44px; 
            margin-bottom:12px; 
            text-shadow:0 0 10px var(--accent); 
        }
        h2 { 
            color:#ff6b6b; 
            font-size:32px; 
            margin-bottom:12px; 
        }
        h3 {
            color: var(--accent);
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--accent);
        }
        button {
            background: linear-gradient(to bottom,var(--accent),#302b63); 
            color:white; 
            border:none;
            padding:12px 24px; 
            font-size:18px; 
            border-radius:30px; 
            cursor:pointer; 
            margin-top:12px;
            box-shadow:0 0 12px rgba(74,71,163,0.7); 
            transition: all 0.18s ease;
            min-height: 50px;
            min-width: 160px;
            position: relative;
            z-index: 101;
        }
        button:hover, button:active { 
            transform:scale(1.02); 
            box-shadow:0 0 18px rgba(74,71,163,0.9); 
        }
        .instructions { 
            margin-top:12px; 
            max-width:90%; 
            line-height:1.4; 
            font-size:15px; 
            text-align: center;
        }
        .controls { 
            display:flex; 
            justify-content:center; 
            gap:20px; 
            margin-top:12px; 
        }
        .control-item { 
            text-align:center; 
            font-size:14px; 
        }
        .key { 
            display:inline-block; 
            background-color:var(--accent); 
            padding:5px 10px; 
            border-radius:5px; 
            margin:0 5px; 
            box-shadow:0 0 5px rgba(74,71,163,0.7); 
        }

        /* Mobile touch controls */
        .touch-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display:flex;
            gap:12px;
            align-items:center;
            pointer-events: auto;
            z-index: 50;
        }
        .touch-btn {
            width: 72px;
            height: 72px;
            border-radius: 14px;
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.08));
            border: 1px solid rgba(255,255,255,0.06);
            display:flex;
            justify-content:center;
            align-items:center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        .touch-btn:active { 
            transform: translateY(2px); 
        }

        .touch-btn.small { 
            width: 56px; 
            height:56px; 
            border-radius:12px; 
            font-size:18px; 
        }

        @media (min-width:600px){
            #game-ui { font-size:20px; }
            h1 { font-size:48px; }
            h2 { font-size:36px; }
            h3 { font-size: 40px; }
        }
        
        @media (max-width: 768px) {
            button {
                padding: 16px 32px;
                font-size: 20px;
                min-height: 60px;
            }
            
            #game-over, #start-screen, #pause-screen {
                padding: 30px 20px;
            }
            
            #pause-button {
                padding: 10px 20px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-ui">
            <div id="score">Score: 0</div>
            <button id="pause-button">PAUSE</button>
            <div id="lives">Lives: 100</div>
        </div>

        <canvas id="game-canvas"></canvas>

        <div id="start-screen">
            <h1>SPACE DEFENDER</h1>
            <p class="instructions">Defend your space from incoming asteroids! Drag on the play area to move the ship. Use the on-screen fire button or the spacebar to shoot.</p>
            <div class="controls">
                <div class="control-item"><p>Move: <span class="key">Drag</span></p></div>
                <div class="control-item"><p>Shoot: <span class="key">Space</span> or <span class="key">Fire</span></p></div>
                <div class="control-item"><p>Pause: <span class="key">P</span></p></div>
            </div>
            <button id="start-button">START GAME</button>
        </div>

        <div id="game-over">
            <h2>GAME OVER</h2>
            <p id="final-score">Your score: 0</p>
            <button id="restart-button">PLAY AGAIN</button>
        </div>
        
        <div id="pause-screen">
            <h3>GAME PAUSED</h3>
            <p class="instructions">Take a break! Your progress is saved.</p>
            <button id="resume-button">RESUME GAME</button>
            <button id="quit-button">QUIT TO MENU</button>
        </div>

        <!-- Touch controls for mobile -->
        <div class="touch-controls" aria-hidden="false">
            <div id="left-btn" class="touch-btn small" role="button" aria-label="Move left">◀</div>
            <div id="fire-btn" class="touch-btn" role="button" aria-label="Fire">FIRE</div>
            <div id="right-btn" class="touch-btn small" role="button" aria-label="Move right">▶</div>
        </div>
    </div>

    <script>
        // GAME CONFIG
        const GAME_WIDTH = 800;
        const GAME_HEIGHT = 500;

        // Elements
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const container = document.getElementById('game-container');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over');
        const pauseScreen = document.getElementById('pause-screen');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const pauseButton = document.getElementById('pause-button');
        const resumeButton = document.getElementById('resume-button');
        const quitButton = document.getElementById('quit-button');
        const scoreDisplay = document.getElementById('score');
        const livesDisplay = document.getElementById('lives');
        const finalScoreDisplay = document.getElementById('final-score');
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');
        const fireBtn = document.getElementById('fire-btn');

        // State
        let gameActive = false;
        let gamePaused = false;
        let score = 0;
        let lives = 100;
        let asteroidSpawnTimer = null; // Track the asteroid spawn timer

        const player = {
            x: GAME_WIDTH / 2 - 25,
            y: GAME_HEIGHT - 60,
            width: 50, height: 50,
            speed: 6.5,
            color: '#4a47a3'
        };

        let bullets = [];
        let asteroids = [];
        let particles = [];
        let keys = {};
        let leftHold = false, rightHold = false;

        // Pointer drag state for touch/mouse movement
        let isPointerDown = false;

        // Stars precomputed (avoid re-randomizing every frame for perf)
        const stars = [];
        const STAR_COUNT = 60;
        for (let i = 0; i < STAR_COUNT; i++) {
            stars.push({
                x: Math.random() * GAME_WIDTH,
                y: Math.random() * GAME_HEIGHT,
                size: Math.random() * 1.8,
                alpha: 0.4 + Math.random() * 0.6
            });
        }

        // Resize / high-DPI handling
        function resizeCanvas() {
            const containerWidth = container.clientWidth;
            const displayWidth = Math.min(GAME_WIDTH, containerWidth);
            const displayHeight = Math.round(displayWidth * GAME_HEIGHT / GAME_WIDTH);
            const dpr = Math.max(1, window.devicePixelRatio || 1);

            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';
            canvas.width = Math.round(displayWidth * dpr);
            canvas.height = Math.round(displayHeight * dpr);

            const scaleX = canvas.width / displayWidth;
            const scaleY = canvas.height / displayHeight;
            ctx.setTransform(scaleX * (displayWidth / GAME_WIDTH), 0, 0, scaleY * (displayHeight / GAME_HEIGHT), 0, 0);
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Input: keyboard
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            
            // Support spacebar via code or ' '
            if ((e.key === ' ' || e.code === 'Space') && gameActive && !gamePaused) shoot();
            
            // Pause with P key
            if ((e.key === 'p' || e.key === 'P' || e.key === 'Escape') && gameActive) {
                togglePause();
            }
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Touch / pointer-based movement
        function updatePlayerWithPointer(e) {
            const rect = canvas.getBoundingClientRect();
            const displayWidth = rect.width;
            const scale = displayWidth / GAME_WIDTH;
            const xInGame = (e.clientX - rect.left) / scale;
            player.x = Math.max(0, Math.min(GAME_WIDTH - player.width, xInGame - player.width / 2));
        }

        canvas.addEventListener('pointerdown', (e) => {
            if (!gameActive || gamePaused) return;
            if (e.isPrimary) {
                isPointerDown = true;
                canvas.setPointerCapture && canvas.setPointerCapture(e.pointerId);
                updatePlayerWithPointer(e);
            }
        });
        
        canvas.addEventListener('pointermove', (e) => {
            if (isPointerDown && e.isPrimary) updatePlayerWithPointer(e);
        });
        
        canvas.addEventListener('pointerup', (e) => {
            if (e.isPrimary) {
                isPointerDown = false;
                try { canvas.releasePointerCapture && canvas.releasePointerCapture(e.pointerId); } catch {}
            }
        });

        // On-screen buttons behavior
        function bindButtonHold(btn, onHoldStart, onHoldEnd) {
            let hold = false;
            const start = (e) => {
                if (gamePaused) return;
                e.preventDefault();
                hold = true;
                onHoldStart();
            };
            const end = (e) => {
                e.preventDefault();
                hold = false;
                onHoldEnd();
            };
            btn.addEventListener('pointerdown', start);
            window.addEventListener('pointerup', end);
            btn.addEventListener('pointercancel', end);
            btn.addEventListener('lostpointercapture', end);
            btn.addEventListener('click', (e) => {
                e.preventDefault();
            });
        }

        bindButtonHold(leftBtn, () => leftHold = true, () => leftHold = false);
        bindButtonHold(rightBtn, () => rightHold = true, () => rightHold = false);
        
        let fireRepeatTimer = null;
        bindButtonHold(fireBtn,
            () => { 
                if (!gamePaused) {
                    shoot(); 
                    fireRepeatTimer = setInterval(shoot, 180); 
                }
            },
            () => { clearInterval(fireRepeatTimer); fireRepeatTimer = null; }
        );

        // Button event handling
        function setupButton(button, handler) {
            // Clear any existing event listeners
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            // Add new event listeners
            newButton.addEventListener('click', handler);
            newButton.addEventListener('touchstart', function(e) {
                e.preventDefault();
                handler();
            }, { passive: false });
            
            return newButton;
        }

        // Reinitialize buttons with proper event handlers
        let newStartButton = setupButton(startButton, startGame);
        let newRestartButton = setupButton(restartButton, startGame);
        
        // Pause button
        pauseButton.addEventListener('click', togglePause);
        pauseButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
            togglePause();
        });
        
        // Resume button
        resumeButton.addEventListener('click', togglePause);
        resumeButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
            togglePause();
        });
        
        // Quit button
        quitButton.addEventListener('click', quitToMenu);
        quitButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
            quitToMenu();
        });

        // Pause/Resume function
        function togglePause() {
            if (!gameActive) return;
            
            gamePaused = !gamePaused;
            
            if (gamePaused) {
                pauseScreen.style.display = 'flex';
                pauseButton.textContent = 'RESUME';
                // Clear the asteroid spawn timer when paused
                if (asteroidSpawnTimer) {
                    clearTimeout(asteroidSpawnTimer);
                    asteroidSpawnTimer = null;
                }
            } else {
                pauseScreen.style.display = 'none';
                pauseButton.textContent = 'PAUSE';
                // Restart asteroid spawning when resuming
                if (gameActive && !asteroidSpawnTimer) {
                    asteroidSpawner();
                }
                // Resume the game loop if it was running
                if (gameActive) {
                    requestAnimationFrame(gameLoop);
                }
            }
        }
        
        // Quit to menu function
        function quitToMenu() {
            gameActive = false;
            gamePaused = false;
            // Clear all timers
            if (asteroidSpawnTimer) {
                clearTimeout(asteroidSpawnTimer);
                asteroidSpawnTimer = null;
            }
            if (fireRepeatTimer) {
                clearInterval(fireRepeatTimer);
                fireRepeatTimer = null;
            }
            pauseScreen.style.display = 'none';
            startScreen.style.display = 'flex';
            pauseButton.style.display = 'none';
        }

        function startGame() {
            if (gameActive) return;
            gameActive = true;
            gamePaused = false;
            score = 0;
            lives = 100;
            bullets = [];
            asteroids = [];
            particles = [];
            player.x = GAME_WIDTH / 2 - player.width / 2;
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            pauseScreen.style.display = 'none';
            pauseButton.style.display = 'block'; // Show pause button
            pauseButton.textContent = 'PAUSE';
            updateScore();
            updateLives();
            
            // Clear any existing timer and start fresh
            if (asteroidSpawnTimer) {
                clearTimeout(asteroidSpawnTimer);
            }
            asteroidSpawner();
            
            resizeCanvas();
            requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            gameActive = false;
            gamePaused = false;
            // Clear the asteroid spawn timer
            if (asteroidSpawnTimer) {
                clearTimeout(asteroidSpawnTimer);
                asteroidSpawnTimer = null;
            }
            pauseButton.style.display = 'none'; // Hide pause button
            finalScoreDisplay.textContent = `Your score: ${score}`;
            gameOverScreen.style.display = 'flex';
        }

        function updateScore(){ scoreDisplay.textContent = `Score: ${score}`; }
        function updateLives(){ livesDisplay.textContent = `Lives: ${lives}`; }

        function shoot(){
            if (!gameActive || gamePaused) return;
            bullets.push({
                x: player.x + player.width / 2 - 2,
                y: player.y - 4,
                width: 4, height: 15, speed: 10
            });
        }

        // FIXED: Asteroid spawner function - now uses a timer that's properly managed
        function asteroidSpawner(){
            if (!gameActive || gamePaused) return;
            
            const size = Math.random() * 30 + 20;
            asteroids.push({
                x: Math.random() * (GAME_WIDTH - size),
                y: -size, 
                width: size, 
                height: size,
                speed: Math.random() * 2 + 1
            });
            
            // Calculate next spawn time (gradually gets faster as score increases)
            let baseSpawnTime = Math.max(200, 1000 - (score * 2)); // Minimum 200ms, gets faster with score
            const nextSpawn = Math.random() * baseSpawnTime + baseSpawnTime;
            
            // Use a variable to track the timer so we can clear it when needed
            asteroidSpawnTimer = setTimeout(asteroidSpawner, nextSpawn);
        }

        function createParticles(x,y,color,count){
            for(let i=0;i<count;i++){
                particles.push({
                    x,y,
                    size: Math.random()*3+1,
                    speedX: (Math.random()*4-2) * 0.8,
                    speedY: (Math.random()*4-2) * 0.8,
                    color, life: 24
                });
            }
        }

        function update(){
            if (gamePaused) return;
            
            // movement from keyboard
            if (keys['ArrowLeft'] || keys['a']) player.x -= player.speed;
            if (keys['ArrowRight'] || keys['d']) player.x += player.speed;

            // movement from on-screen hold buttons
            if (leftHold) player.x -= player.speed;
            if (rightHold) player.x += player.speed;

            // clamp
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > GAME_WIDTH) player.x = GAME_WIDTH - player.width;

            for (let i = bullets.length - 1; i >= 0; i--){
                bullets[i].y -= bullets[i].speed;
                if (bullets[i].y + bullets[i].height < 0) bullets.splice(i,1);
            }

            for (let i = asteroids.length - 1; i >= 0; i--){
                asteroids[i].y += asteroids[i].speed;
                if (asteroids[i].y > GAME_HEIGHT){
                    asteroids.splice(i,1);
                    lives--; updateLives();
                    if (lives <= 0) gameOver();
                }
            }

            // collisions: bullets vs asteroids
            for (let i = asteroids.length - 1; i >= 0; i--){
                for (let j = bullets.length - 1; j >= 0; j--){
                    const a = asteroids[i], b = bullets[j];
                    if (b.x < a.x + a.width && b.x + b.width > a.x && b.y < a.y + a.height && b.y + b.height > a.y){
                        createParticles(a.x + a.width/2, a.y + a.height/2, '#ff6b6b', 8);
                        asteroids.splice(i,1);
                        bullets.splice(j,1);
                        score += 10; updateScore();
                        break;
                    }
                }
            }

            for (let i = particles.length - 1; i >= 0; i--){
                particles[i].x += particles[i].speedX;
                particles[i].y += particles[i].speedY;
                particles[i].life--;
                if (particles[i].life <= 0) particles.splice(i,1);
            }
        }

        function draw(){
            ctx.fillStyle = '#0a0a2a';
            ctx.fillRect(0,0,GAME_WIDTH,GAME_HEIGHT);

            for (const s of stars){
                ctx.globalAlpha = s.alpha;
                ctx.fillStyle = 'white';
                ctx.fillRect(s.x, s.y, s.size, s.size);
            }
            ctx.globalAlpha = 1;

            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.moveTo(player.x + player.width/2, player.y);
            ctx.lineTo(player.x + player.width, player.y + player.height);
            ctx.lineTo(player.x, player.y + player.height);
            ctx.closePath();
            ctx.fill();

            ctx.fillStyle = '#ff6b6b';
            for (const bullet of bullets) ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);

            for (const asteroid of asteroids){
                ctx.fillStyle = '#8a8a8a';
                ctx.beginPath();
                ctx.arc(asteroid.x + asteroid.width/2, asteroid.y + asteroid.height/2, asteroid.width/2, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = '#6a6a6a';
                ctx.beginPath();
                ctx.arc(asteroid.x + asteroid.width/3, asteroid.y + asteroid.height/3, asteroid.width/6, 0, Math.PI*2);
                ctx.fill();
            }

            for (const particle of particles){
                ctx.fillStyle = particle.color;
                ctx.globalAlpha = Math.max(0, particle.life / 24);
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI*2);
                ctx.fill();
            }
            
            // Draw "PAUSED" text if game is paused
            if (gamePaused) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('PAUSED', GAME_WIDTH / 2, GAME_HEIGHT / 2);
            }
            
            ctx.globalAlpha = 1;
        }

        function gameLoop(){
            if (!gameActive || gamePaused) return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        draw();

        function tryAutoStart(){
            const params = new URLSearchParams(window.location.search);
            if (params.get('autostart') === '1') {
                startGame();
                document.body.addEventListener('pointerdown', function onFirstInteraction() {
                    document.body.removeEventListener('pointerdown', onFirstInteraction);
                }, { once: true });
            }
        }

        window.addEventListener('DOMContentLoaded', tryAutoStart);

        window.addEventListener('contextmenu', (e) => {
            if (gameActive) e.preventDefault();
        }, { passive: false });

    </script>
</body>
</html>
